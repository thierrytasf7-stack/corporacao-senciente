# Known Gotchas

> Auto-generated from session insights
> Last updated: 2026-02-07T02:00:00.000Z
> Total gotchas: 6

This document contains common pitfalls and their solutions discovered during development.
Each gotcha includes the **wrong** approach, the **right** approach, and the **reason** why.

---

## Table of Contents

- [State Management](#state-management) (1)
- [API](#api) (2)
- [Nushell Scripting](#nushell-scripting) (1)
- [Node.js & NPM](#nodejs--npm) (1)
- [Other](#other) (1)

---

## State Management

### Zustand Persist Type Inference

**[MEDIUM]**

**Wrong:**

```typescript
const useStore = create(
  persist((set) => ({ ... }), { name: 'store' })
);
```

**Right:**

```typescript
const useStore = create<StoreType>()(
  persist((set) => ({ ... }), { name: 'store' })
);
```

**Reason:** Without explicit type parameter and extra parentheses, TypeScript cannot infer the store type correctly.

**Severity:** Medium

**Discovered:** STORY-7.4-TEST (2026-01-29)

**Related Files:** src/stores/authStore.ts

---

## API

### Fetch Error Handling

**[HIGH]**

**Wrong:**

```typescript
const data = await fetch(url).then((r) => r.json());
```

**Right:**

```typescript
const response = await fetch(url);
if (!response.ok) {
  throw new Error(`HTTP ${response.status}`);
}
const data = await response.json();
```

**Reason:** fetch() doesn't throw on HTTP errors (4xx, 5xx), only on network failures.

**Severity:** High

**Discovered:** STORY-7.4-TEST (2026-01-29)

**Related Files:** src/lib/api.ts

---

### Zustand persist middleware requires async hydration - com...

**[HIGH]**

**Reason:** Zustand persist middleware requires async hydration - common pitfall is to not wait for hydration

**Severity:** High

**Discovered:** STORY-7.4-TEST (2026-01-29)

**Related Files:** src/stores/authStore.ts

---

## Nushell Scripting

### Missing Utility Functions causing Crashes

**[CRITICAL]**

**Wrong:**
Deleting helper functions like `read_file_safely` thinking they are unused, or relying on external commands that might not exist in the minimal shell environment.

**Right:**
Always keep the core utility functions (`read_file_safely`, `write_log`, `register_on_dashboard`) defined at the top of the worker scripts (`.nu`). Wrap execution in `try/catch` with a `sleep` in the catch block to debug crashes.

**Reason:** Nushell scripts running in new windows close immediately on error. Without internal error handling and logging, debugging "flash close" windows is impossible.

**Severity:** Critical

**Discovered:** HIVE-GUARDIAN-V3.4 (2026-02-07)

**Related Files:** scripts/aider-worker-engine.nu, scripts/observer-engine.nu

---

## Node.js & NPM

### JSON Parse Error due to Merge Conflicts

**[HIGH]**

**Wrong:**
Leaving `<<<<<<< HEAD` markers in `package.json` after a merge attempt.

**Right:**
Manually resolve conflicts in `package.json` ensuring the structure remains valid JSON (remove all git markers).

**Reason:** `npm run dev` or any npm command will fail with `EJSONPARSE` if `package.json` contains invalid JSON syntax.

**Severity:** High

**Discovered:** DASHBOARD-STARTUP (2026-02-07)

**Related Files:** aios-core-latest/apps/dashboard/package.json

---

## Other

### React useEffect Cleanup

**[HIGH]**

**Wrong:**

```typescript
useEffect(() => {
  fetchData();
}, [id]);
```

**Right:**

```typescript
useEffect(() => {
  let cancelled = false;
  const fetch = async () => {
    const data = await fetchData();
    if (!cancelled) setData(data);
  };
  fetch();
  return () => {
    cancelled = true;
  };
}, [id]);
```

**Reason:** Without cleanup, race conditions can occur when the component unmounts or dependencies change before the async operation completes.

**Severity:** High

**Discovered:** STORY-7.4-TEST (2026-01-29)

---

---

## Statistics

| Metric            | Value |
| ----------------- | ----- |
| Total Gotchas     | 6     |
| Categories        | 5     |
| Insights Scanned  | 1     |
| Duplicates Merged | 0     |

---

_Generated by AIOS Gotchas Documenter v1.0.0_