# Migration Guide: AIOS v2.0 to v2.1

**Version:** 2.1.0
**Last Updated:** 2026-01-28
**Audience:** Developers migrating existing AIOS v2.0 projects to v2.1

---

## Overview

AIOS v2.1 introduces significant architectural changes while maintaining backward compatibility for most features. This guide covers breaking changes, new features, deprecated items, and step-by-step migration instructions.

**Estimated Migration Time:** 45-60 minutes for typical projects

---

## Quick Reference

| Category        | v2.0                | v2.1                 | Action Required         |
| --------------- | ------------------- | -------------------- | ----------------------- |
| Workers         | Closed source       | Open source          | None (beneficial)       |
| Expansion Packs | `expansion-packs/`  | `squads/`            | Rename directory        |
| Quality Gates   | 1 layer (manual)    | 3 layers (automated) | Configure new gates     |
| Story Template  | v1.0                | v2.0                 | Update existing stories |
| npm Packages    | `@synkra/aios-core` | `@aios/core`         | Update package.json     |

---

## Breaking Changes

### 1. Directory Structure Changes

#### Expansion Packs to Squads

The "Expansion Pack" terminology has been replaced with "Squad" throughout the framework.

**Before (v2.0):**

```
expansion-packs/
├── etl/
├── creator/
└── mmos-mapper/
```

**After (v2.1):**

```
squads/
├── etl/
├── creator/
└── mmos-mapper/
```

**Migration:**

```bash
# Rename directory
mv expansion-packs squads

# Update any references in your code
find . -type f -name "*.md" -exec sed -i '' 's/expansion-packs/squads/g' {} +
find . -type f -name "*.yaml" -exec sed -i '' 's/expansion-packs/squads/g' {} +
```

### 2. Manifest File Rename

**Before (v2.0):** `pack.yaml`
**After (v2.1):** `squad.yaml`

```bash
# Rename manifest files
find squads -name "pack.yaml" -exec sh -c 'mv "$1" "$(dirname "$1")/squad.yaml"' _ {} \;
```

### 3. npm Package Scope Change

**Before (v2.0):**

```json
{
  "dependencies": {
    "@synkra/aios-core": "^2.0.0"
  }
}
```

**After (v2.1):**

```json
{
  "dependencies": {
    "@aios/core": "^2.1.0"
  }
}
```

**Squad packages:**

- `@expansion/etl` -> `@aios/squad-etl`
- `@expansion/creator` -> `@aios/squad-creator`

### 4. Configuration File Changes

#### .aios-installation-config.yaml

New fields required in v2.1:

```yaml
# Add these new fields
version: '2.1'
quality_gates:
  layer1_enabled: true
  layer2_enabled: true
  layer3_enabled: true
squad_discovery:
  local: true
  remote: false
```

---

## New Features

### 1. Modular Architecture (4 Modules)

AIOS v2.1 reorganizes the framework into 4 distinct modules:

```
.aios-core/
├── core/              # Framework foundations (no dependencies)
│   ├── config/        # Configuration management
│   ├── registry/      # Service Discovery
│   ├── quality-gates/ # 3-layer QG system
│   ├── mcp/           # MCP global configuration
│   └── session/       # Session management
│
├── development/       # Development artifacts
│   ├── agents/        # 11 agent definitions
│   ├── tasks/         # 115+ task definitions
│   ├── workflows/     # 7 workflow definitions
│   └── scripts/       # Dev support utilities
│
├── product/           # User-facing templates
│   ├── templates/     # 52+ templates
│   ├── checklists/    # 11 checklists
│   └── data/          # PM knowledge base
│
└── infrastructure/    # System configuration
    ├── scripts/       # 55+ infrastructure scripts
    ├── tools/         # CLI, MCP, local configs
    └── integrations/  # PM adapters (ClickUp, Jira)
```

### 2. Squad System

The new Squad system provides better modularity and community contribution support.

**Creating a Squad:**

```yaml
# squad.yaml
name: my-custom-squad
version: 1.0.0
description: Custom automation squad
license: MIT

peerDependencies:
  '@aios/core': '^2.1.0'

agents:
  - id: custom-agent
    extends: dev

tasks:
  - custom-task-1
  - custom-task-2

exports:
  - agents
  - tasks
```

### 3. Quality Gates 3 Layers

v2.1 introduces automated quality enforcement across 3 layers:

| Layer                  | Executor           | Tool                | Catches           |
| ---------------------- | ------------------ | ------------------- | ----------------- |
| Layer 1: Local         | Worker             | Husky + lint-staged | 30%               |
| Layer 2: PR Automation | Agent + CodeRabbit | GitHub Actions      | +50% (80% total)  |
| Layer 3: Human Review  | Human              | CODEOWNERS          | +20% (100% total) |

**Setup Layer 1 (Pre-commit):**

```bash
# Install husky
npm install -D husky lint-staged

# Configure .husky/pre-commit
#!/bin/sh
npx lint-staged
npm run typecheck
npm test -- --onlyChanged
```

**Setup Layer 2 (GitHub Actions):**

Create `.github/workflows/quality-gates-pr.yml`:

```yaml
name: Quality Gates PR
on: [pull_request]
jobs:
  layer2:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: npm ci
      - run: npm run lint
      - run: npm run typecheck
      - run: npm test -- --coverage
      - run: npm audit --audit-level=high
```

### 4. Story Template v2.0

New sections in story templates:

- **Cross-Story Decisions** - Track decisions affecting multiple stories
- **CodeRabbit Integration** - Story type analysis and agent assignment
- **Dev Agent Record** - Execution logging

### 5. Service Discovery

Find and reuse Workers across projects:

```bash
# Search for workers
aios workers search "json parse"

# Use worker in task
aios workers use json-parser --task my-task
```

### 6. Task-First Architecture

Tasks are now universal, with executors as attributes:

```yaml
# v2.0 - Separate implementations
agent_task.md:
  executor: Agent

worker_task.js:
  executor: Worker

# v2.1 - Universal task
task: analyzeMarket()
inputs: { market_data: object }
outputs: { insights: array }
responsavel_type: Worker # Change this field to switch executors
```

---

## Deprecated Features

### 1. Expansion Pack Terminology

| Deprecated         | Replacement     | Removal Date |
| ------------------ | --------------- | ------------ |
| `expansion-packs/` | `squads/`       | v3.0.0       |
| `pack.yaml`        | `squad.yaml`    | v3.0.0       |
| `@expansion/*`     | `@aios/squad-*` | v3.0.0       |

### 2. Single-Layer Quality Gates

The manual single-layer quality gate approach is deprecated. Projects should adopt the 3-layer system.

### 3. Legacy Story Template

Story Template v1.0 is deprecated. New stories must use v2.0 format with:

- Cross-Story Decisions section
- CodeRabbit Integration section
- Dev Agent Record section

---

## Migration Steps

### Step 1: Update Dependencies

```bash
# Update package.json
npm uninstall @synkra/aios-core
npm install @aios/core@^2.1.0

# Update squad packages if using any
npm uninstall @expansion/etl
npm install @aios/squad-etl
```

### Step 2: Rename Directories

```bash
# Rename expansion-packs to squads
if [ -d "expansion-packs" ]; then
  mv expansion-packs squads
fi

# Rename pack.yaml to squad.yaml
find squads -name "pack.yaml" -exec sh -c 'mv "$1" "$(dirname "$1")/squad.yaml"' _ {} \;
```

### Step 3: Update Configuration

Edit `.aios-installation-config.yaml`:

```yaml
# Add v2.1 configuration
version: '2.1'
quality_gates:
  layer1_enabled: true
  layer2_enabled: true
  layer3_enabled: true
```

### Step 4: Setup Quality Gates

```bash
# Install pre-commit hooks
npm install -D husky lint-staged
npx husky install
npx husky add .husky/pre-commit "npx lint-staged"

# Add GitHub Actions workflow
# Copy from .aios-core/infrastructure/templates/github-actions-ci.yml
```

### Step 5: Update Existing Stories

For each story in `docs/stories/`:

1. Add Cross-Story Decisions section after metadata
2. Add CodeRabbit Integration section before Dev Agent Record
3. Ensure QA Results section exists

### Step 6: Update References

```bash
# Find and update old references
grep -r "expansion-pack" --include="*.md" --include="*.yaml" --include="*.json"

# Update manually or use sed
find . -type f \( -name "*.md" -o -name "*.yaml" -o -name "*.json" \) \
  -exec sed -i '' 's/expansion-pack/squad/g' {} +
```

### Step 7: Verify Migration

```bash
# Run AIOS validation
npx @aios/core validate

# Run tests
npm test

# Check for deprecated references
grep -r "@synkra/aios-core" --include="*.json"
grep -r "expansion-pack" --include="*.md" --include="*.yaml"
```

---

## Troubleshooting

### Issue: "Module not found: @aios/core"

**Cause:** Package scope changed from `@synkra` to `@aios`

**Solution:**

```bash
npm uninstall @synkra/aios-core
npm install @aios/core
```

### Issue: "pack.yaml not found"

**Cause:** Manifest file renamed to `squad.yaml`

**Solution:**

```bash
mv squads/*/pack.yaml squads/*/squad.yaml
```

### Issue: Quality Gate Layer 2 Failing

**Cause:** GitHub Actions workflow not configured

**Solution:**

1. Copy workflow template from `.aios-core/infrastructure/templates/`
2. Ensure CodeRabbit is configured in repository settings
3. Check branch protection rules

### Issue: Story Template Validation Errors

**Cause:** Missing new v2.0 sections

**Solution:**
Add the following sections to your stories:

```markdown
## Cross-Story Decisions

| Decision | Source | Impact on This Story |
| -------- | ------ | -------------------- |

## CodeRabbit Integration

### Story Type Analysis

| Attribute | Value | Rationale |
| --------- | ----- | --------- |
```

### Issue: Service Discovery Not Working

**Cause:** Registry not initialized

**Solution:**

```bash
aios registry init
aios workers sync
```

---

## Version History

| Version | Date       | Changes                                                   |
| ------- | ---------- | --------------------------------------------------------- |
| 2.0.0   | 2025-01-19 | Initial v2.0 release                                      |
| 2.1.0   | 2025-12-09 | Modular architecture, Squads, Multi-repo, QG3, Story v2.0 |

---

## Additional Resources

- [AIOS Livro de Ouro v2.1](../../.aios-core/docs/standards/AIOS-LIVRO-DE-OURO-V2.1-COMPLETE.md)
- [Quality Gates Specification](../../.aios-core/docs/standards/QUALITY-GATES-SPECIFICATION.md)
- [Story Template v2 Specification](../../.aios-core/docs/standards/STORY-TEMPLATE-V2-SPECIFICATION.md)
- [Multi-Repo Strategy](../architecture/multi-repo-strategy.md)

---

## Support

If you encounter issues during migration:

1. Check the [Troubleshooting](#troubleshooting) section above
2. Search [existing issues](https://github.com/SynkraAI/aios-core/issues)
3. Open a [new issue](https://github.com/SynkraAI/aios-core/issues/new) with the `migration` label
4. Join the [Discussions](https://github.com/SynkraAI/aios-core/discussions) for community help

---

_Last Updated: 2026-01-28 | AIOS Framework Team_
