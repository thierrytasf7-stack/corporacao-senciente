# [STORY-20260213011131-5] Websocket para Notificacoes em Tempo Real
> **Status:** REVISADO
> **subStatus:** waiting_human_approval
> **Agente Sugerido:** @agente-zero
> **Agente AIOS:** üèõÔ∏è @architect (Aria) - Architect
> **Skill:** `/AIOS:agents:architect`
> **Tipo:** feature
> **Dificuldade:** HARD
> **Prioridade:** Alta
> **Criado em:** 2026-02-13 01:11:31

## Contexto
Atualmente o dashboard depende de polling a cada 3-5 segundos para atualizar dados. Websockets eliminam latencia de atualizacao e reduzem carga no servidor, alinhando com o principio CLI First onde eventos fluem do sistema para a observabilidade.

## Objetivo
Implementar canal websocket no monitor-server para emitir eventos de stories criadas, tasks completadas e alertas de agentes. O dashboard deve consumir esses eventos e atualizar a UI automaticamente sem polling.

## Responsavel
**üèõÔ∏è Aria** (Architect) e o agente AIOS responsavel por esta task.
- **Foco:** System design, API design, tech stack selection, arquitetura cross-stack
- **Invocacao:** `/AIOS:agents:architect`
- **Executor runtime:** `@agente-zero` (worker autonomo que processa a story)

## Arquivos Alvo
- `apps/dashboard/src/components/`
- `apps/dashboard/src/hooks/`
- `apps/dashboard/src/stores/`

## Output Esperado
- Endpoint ws:// funcional no monitor-server com Bun.serve
- Arquivo apps/dashboard/src/hooks/use-websocket.ts exportando hook com reconexao automatica
- Componente ConnectionIndicator exibindo status verde/amarelo/vermelho no header
- Store Zustand atualizada automaticamente ao receber eventos via websocket

## Acceptance Criteria
- [?] Servidor websocket rodando no monitor-server
- [?] Hook useWebSocket criado para consumir eventos
- [?] Dashboard atualiza automaticamente ao receber eventos
- [?] Reconexao automatica em caso de desconexao
- [?] Indicador visual de status da conexao no dashboard

## Constraints
- Usar Bun nativo para websocket no monitor-server, sem bibliotecas externas
- Hook deve seguir pattern existente em use-workers.ts (useSWR-compatible)
- Protocolo de mensagens em JSON com campo type discriminante
- NAO modificar arquivos fora do escopo listado em Arquivos Alvo
- NAO introduzir dependencias externas sem justificativa
- NAO quebrar funcionalidades existentes

## Instrucoes
1. Criar endpoint websocket no monitor-server usando Bun.serve. 2. Definir protocolo de mensagens com tipos: story_created, task_completed, agent_alert. 3. Criar hook useWebSocket em apps/dashboard/src/hooks/. 4. Integrar o hook nos componentes de lista de stories e painel de agentes. 5. Adicionar indicador de conexao no header do dashboard.

## Exemplo de Referencia
```
export function useWebSocket(url: string) {
  const [status, setStatus] = useState<'connected' | 'disconnected' | 'reconnecting'>('disconnected');
  const wsRef = useRef<WebSocket | null>(null);

  useEffect(() => {
    const ws = new WebSocket(url);
    ws.onopen = () => setStatus('connected');
    ws.onclose = () => { setStatus('reconnecting'); /* retry logic */ };
    ws.onmessage = (e) => { const msg = JSON.parse(e.data); /* dispatch */ };
    wsRef.current = ws;
    return () => ws.close();
  }, [url]);

  return { status };
}
```


## Execution Log
> Executed at: 2026-02-13T01:11:50.143032
> Total targets: 3
> Files checked: 75
> Overall: HAS FAILURES
> apps\dashboard\src\components\agents\AgentCard.tsx: PASS - JSX/TSX OK (6060 bytes)
> apps\dashboard\src\components\agents\AgentMonitor.tsx: PASS - JSX/TSX OK (6133 bytes)
> apps\dashboard\src\components\agents\index.ts: PASS - JS/TS syntax OK
> apps\dashboard\src\components\context\ContextPanel.tsx: PASS - JSX/TSX OK (10385 bytes)
> apps\dashboard\src\components\context\index.ts: PASS - JS/TS syntax OK
> apps\dashboard\src\components\github\GitHubPanel.tsx: PASS - JSX/TSX OK (12147 bytes)
> apps\dashboard\src\components\github\index.ts: PASS - JS/TS syntax OK
> apps\dashboard\src\components\insights\InsightsPanel.tsx: PASS - JSX/TSX OK (11533 bytes)
> apps\dashboard\src\components\insights\index.ts: PASS - JS/TS syntax OK
> apps\dashboard\src\components\kanban\KanbanBoard.tsx: PASS - JSX/TSX OK (8431 bytes)
> apps\dashboard\src\components\kanban\KanbanColumn.tsx: PASS - JSX/TSX OK (6177 bytes)
> apps\dashboard\src\components\kanban\SortableStoryCard.tsx: PASS - JSX/TSX OK (1685 bytes)
> apps\dashboard\src\components\kanban\index.ts: PASS - JS/TS syntax OK
> apps\dashboard\src\components\layout\AppShell.tsx: PASS - JSX/TSX OK (4517 bytes)
> apps\dashboard\src\components\layout\ProjectTabs.tsx: PASS - JSX/TSX OK (6185 bytes)
> apps\dashboard\src\components\layout\Sidebar.tsx: PASS - JSX/TSX OK (4954 bytes)
> apps\dashboard\src\components\layout\StatusBar.tsx: PASS - JSX/TSX OK (4221 bytes)
> apps\dashboard\src\components\layout\index.ts: PASS - JS/TS syntax OK
> apps\dashboard\src\components\monitor\ActivityFeed.tsx: PASS - JSX/TSX OK (8426 bytes)
> apps\dashboard\src\components\monitor\CommandPanel.tsx: PASS - JSX/TSX OK (4465 bytes)
> apps\dashboard\src\components\monitor\CurrentToolIndicator.tsx: PASS - JSX/TSX OK (3386 bytes)
> apps\dashboard\src\components\monitor\MonitorPanel.tsx: PASS - JSX/TSX OK (3474 bytes)
> apps\dashboard\src\components\monitor\MonitorStatus.tsx: PASS - JSX/TSX OK (2687 bytes)
> apps\dashboard\src\components\monitor\index.ts: PASS - JS/TS syntax OK
> apps\dashboard\src\components\qa\QAMetricsPanel.tsx: PASS - JSX/TSX OK (20504 bytes)
> apps\dashboard\src\components\roadmap\RoadmapCard.tsx: PASS - JSX/TSX OK (2103 bytes)
> apps\dashboard\src\components\roadmap\RoadmapView.tsx: PASS - JSX/TSX OK (10324 bytes)
> apps\dashboard\src\components\roadmap\index.ts: PASS - JS/TS syntax OK
> apps\dashboard\src\components\settings\SettingsPanel.tsx: PASS - JSX/TSX OK (10700 bytes)
> apps\dashboard\src\components\settings\index.ts: PASS - JS/TS syntax OK
> apps\dashboard\src\components\stories\StoryCard.tsx: PASS - JSX/TSX OK (4076 bytes)
> apps\dashboard\src\components\stories\StoryCreateModal.tsx: PASS - JSX/TSX OK (14066 bytes)
> apps\dashboard\src\components\stories\StoryDetailModal.tsx: PASS - JSX/TSX OK (8890 bytes)
> apps\dashboard\src\components\stories\StoryEditModal.tsx: PASS - JSX/TSX OK (18265 bytes)
> apps\dashboard\src\components\stories\index.ts: PASS - JS/TS syntax OK
> apps\dashboard\src\components\terminal\TerminalOutput.tsx: PASS - JSX/TSX OK (6234 bytes)
> apps\dashboard\src\components\terminal\index.ts: PASS - JS/TS syntax OK
> apps\dashboard\src\components\terminals\TerminalCard.tsx: PASS - JSX/TSX OK (6161 bytes)
> apps\dashboard\src\components\terminals\TerminalGrid.tsx: PASS - JSX/TSX OK (7285 bytes)
> apps\dashboard\src\components\terminals\TerminalOutput.tsx: PASS - JSX/TSX OK (7554 bytes)
> apps\dashboard\src\components\terminals\TerminalStream.tsx: PASS - JSX/TSX OK (9866 bytes)
> apps\dashboard\src\components\terminals\index.ts: PASS - JS/TS syntax OK
> apps\dashboard\src\components\ui\badge.tsx: PASS - JSX/TSX OK (1783 bytes)
> apps\dashboard\src\components\ui\button.tsx: PASS - JSX/TSX OK (2399 bytes)
> apps\dashboard\src\components\ui\context-menu.tsx: PASS - JSX/TSX OK (8274 bytes)
> apps\dashboard\src\components\ui\dialog.tsx: PASS - JSX/TSX OK (4308 bytes)
> apps\dashboard\src\components\ui\fab.tsx: PASS - JSX/TSX OK (3728 bytes)
> apps\dashboard\src\components\ui\icon.tsx: PASS - JSX/TSX OK (949 bytes)
> apps\dashboard\src\components\ui\progress-bar.tsx: PASS - JSX/TSX OK (1250 bytes)
> apps\dashboard\src\components\ui\section-label.tsx: PASS - JSX/TSX OK (1344 bytes)
> apps\dashboard\src\components\ui\skeleton.tsx: PASS - JSX/TSX OK (1847 bytes)
> apps\dashboard\src\components\ui\status-badge.tsx: PASS - JSX/TSX OK (4466 bytes)
> apps\dashboard\src\components\ui\status-dot.tsx: PASS - JSX/TSX OK (1427 bytes)
> apps\dashboard\src\components\ui\tag.tsx: PASS - JSX/TSX OK (4603 bytes)
> apps\dashboard\src\components\workers\WorkerCard.tsx: PASS - JSX/TSX OK (7409 bytes)
> apps\dashboard\src\components\workers\WorkerPanel.tsx: PASS - JSX/TSX OK (4482 bytes)
> apps\dashboard\src\components\workers\index.ts: PASS - JS/TS syntax OK
> apps\dashboard\src\hooks\index.ts: PASS - JS/TS syntax OK
> apps\dashboard\src\hooks\use-agents.ts: PASS - JS/TS syntax OK
> apps\dashboard\src\hooks\use-aios-status.ts: PASS - JS/TS syntax OK
> apps\dashboard\src\hooks\use-monitor-events.ts: PASS - JS/TS syntax OK
> apps\dashboard\src\hooks\use-realtime-status.ts: PASS - JS/TS syntax OK
> apps\dashboard\src\hooks\use-stories.ts: PASS - JS/TS syntax OK
> apps\dashboard\src\hooks\use-workers.ts: PASS - JS/TS syntax OK
> apps\dashboard\src\hooks\useQueryCache.ts: FAIL - C:\Users\User\Desktop\Diana-Corporacao-Senciente\apps\dashboard\src\hooks\useQueryCache.ts:4
interface CacheEntry<T> {
          ^^^^^^^^^^

SyntaxError: Unexpected identifier 'CacheEntry'
    at wrapSafe (node:internal/modules/cjs/loader:1734:18)
    at checkSyntax (node:internal/main/check_syntax:76:3)

Node.js v25.4.0
> apps\dashboard\src\stores\agent-store.ts: PASS - JS/TS syntax OK
> apps\dashboard\src\stores\alert-store.ts: PASS - JS/TS syntax OK
> apps\dashboard\src\stores\index.ts: PASS - JS/TS syntax OK
> apps\dashboard\src\stores\monitor-store.ts: PASS - JS/TS syntax OK
> apps\dashboard\src\stores\projects-store.ts: PASS - JS/TS syntax OK
> apps\dashboard\src\stores\settings-store.ts: PASS - JS/TS syntax OK
> apps\dashboard\src\stores\story-store.ts: PASS - JS/TS syntax OK
> apps\dashboard\src\stores\terminal-store.ts: PASS - JS/TS syntax OK
> apps\dashboard\src\stores\ui-store.ts: PASS - JS/TS syntax OK
> apps\dashboard\src\stores\worker-store.ts: PASS - JS/TS syntax OK
