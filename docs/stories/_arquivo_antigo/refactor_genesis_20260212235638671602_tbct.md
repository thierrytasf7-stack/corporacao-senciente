# [STORY-20260212235638-2] Unificar Funcoes de Parse de Stories entre Workers
> **Status:** REVISADO
> **subStatus:** waiting_human_approval
> **Agente Sugerido:** @aider
> **Agente AIOS:** ðŸ’» @dev (Dex) - Full Stack Developer
> **Skill:** `/AIOS:agents:dev`
> **Tipo:** refactor
> **Dificuldade:** MEDIUM
> **Prioridade:** Alta
> **Criado em:** 2026-02-12 23:56:38

## Contexto
Funcoes duplicadas entre workers sao um risco de drift - uma correcao em um worker pode nao ser replicada nos outros. Unificar em modulo compartilhado garante consistencia no parsing de stories e facilita manutencao futura.

## Objetivo
Os tres workers (genesis, zero, aider) tem funcoes duplicadas para parsear stories: extract_target_files, update_status, read_story. Extrair para modulo compartilhado scripts/story_utils.py para eliminar duplicacao.

## Responsavel
**ðŸ’» Dex** (Full Stack Developer) e o agente AIOS responsavel por esta task.
- **Foco:** Implementacao de codigo, debugging, testes unitarios e de integracao
- **Invocacao:** `/AIOS:agents:dev`
- **Executor runtime:** `@aider` (worker autonomo que processa a story)

## Arquivos Alvo
- `scripts/`

## Output Esperado
- Arquivo scripts/story_utils.py com funcoes: read_story, write_story, update_status, extract_target_files, extract_status
- zero_worker_engine.py importando de story_utils ao inves de ter funcoes locais
- aider_worker_engine.py importando de story_utils ao inves de ter funcoes locais
- Pipeline completo (genesis -> aider -> zero) funcionando sem regressao

## Acceptance Criteria
- [?] Modulo scripts/story_utils.py criado com funcoes compartilhadas
- [?] Funcoes duplicadas removidas dos 3 workers
- [?] Todos os workers importando de story_utils
- [?] Nenhuma regressao no pipeline de processamento

## Constraints
- Manter assinatura identica das funcoes para nao quebrar callsites
- Usar type hints Python em todas as funcoes exportadas
- Nao alterar logica de negocio - apenas mover e unificar
- NAO modificar arquivos fora do escopo listado em Arquivos Alvo
- NAO introduzir dependencias externas sem justificativa
- NAO quebrar funcionalidades existentes

## Instrucoes
1. Mapear funcoes duplicadas em worker_genesis_agent.py, zero_worker_engine.py, aider_worker_engine.py. 2. Criar scripts/story_utils.py com as funcoes unificadas. 3. Refatorar cada worker para importar de story_utils. 4. Rodar cada worker manualmente para validar que nada quebrou.

## Exemplo de Referencia
```
import re
import os

def read_story(filepath: str) -> str:
    with open(filepath, 'r', encoding='utf-8', errors='ignore') as f:
        return f.read()

def update_status(content: str, status: str, sub_status: str) -> str:
    content = re.sub(r'\*\*Status:\*\*\s*\S+', f'**Status:** REVISADO content)
    content = re.sub(r'\*\*subStatus:\*\*\s*\S+', f'**subStatus:** waiting_human_approval content)
    return content

def extract_target_files(content: str) -> list[str]:
    matches = re.findall(r'- `([^`]+)`', content)
    return [m for m in matches if '/' in m or '\\' in m]
```


## Review Results
> Reviewed at: 2026-02-13T00:03:04.965205
> Verdict: FAIL
> Aider log present: False
> Aider result: None
> Files modified by Aider: 0
> All syntax OK: True
> scripts\aider_with_fallback.py: PASS - Python syntax OK
> scripts\aider_worker_engine.py: PASS - Python syntax OK
> scripts\audit-dependencies.py: PASS - Python syntax OK
> scripts\check-diana-status.py: PASS - Python syntax OK
> scripts\gen-audit.py: PASS - Python syntax OK
> scripts\list-diana-procs.py: PASS - Python syntax OK
> scripts\pipeline-validate.py: PASS - Python syntax OK
> scripts\pm2-wrapper.js: PASS - JS/TS syntax OK
> scripts\pm2-wrapper.py: PASS - Python syntax OK
> scripts\qa-explore-routes.js: PASS - JS/TS syntax OK
> scripts\sentinela_escrivao_aider.py: PASS - Python syntax OK
> scripts\sentinela_genesis_saude.py: PASS - Python syntax OK
> scripts\sentinela_revisor_agentezero.py: PASS - Python syntax OK
> scripts\stress-test-20-stories.py: PASS - Python syntax OK
> scripts\stress-test-live.py: PASS - Python syntax OK
> scripts\stress-test-mini.py: PASS - Python syntax OK
> scripts\stress-test-quick.py: PASS - Python syntax OK
> scripts\verificar_sistema.py: PASS - Python syntax OK
> scripts\worker_genesis_agent.py: PASS - Python syntax OK
> scripts\write-audit.js: PASS - JS/TS syntax OK
> scripts\zero_worker_engine.py: PASS - Python syntax OK
> scripts\migration\MigrationState-README.md: PASS - Markdown OK (11783 bytes, has headings)
> scripts\migration\README.md: PASS - Markdown OK (12058 bytes, has headings)
> scripts\migration\TASK-2.1-COMPLETION.md: PASS - Markdown OK (8345 bytes, has headings)
> scripts\migration\TASK-2.2-COMPLETION.md: PASS - Markdown OK (10856 bytes, has headings)
> scripts\migration\docker-cleanup-report.json: PASS - File exists (7785 bytes, no syntax check for .json)
> scripts\migration\inventory.json: PASS - File exists (82490 bytes, no syntax check for .json)
> scripts\migration\sample-inventory-output.json: PASS - File exists (3861 bytes, no syntax check for .json)
> scripts\migration\test-output\container-termination-report.json: PASS - File exists (2357 bytes, no syntax check for .json)
> scripts\migration\test-output\mock-inventory.json: PASS - File exists (417 bytes, no syntax check for .json)
> scripts\migration\test-output\test-inventory.json: PASS - File exists (149 bytes, no syntax check for .json)
> scripts\migration\test-output\test-migration-state.json: PASS - File exists (820 bytes, no syntax check for .json)
> scripts\senciencia\daemon_auto_continue.js: PASS - JS/TS syntax OK

## Aider Processing Log
- **Timestamp:** 2026-02-13 00:04:14
- **Duration:** 120.6s
- **Result:** FAILED
- **Error:** Exit code 1


## Review Results
> Reviewed at: 2026-02-13T00:09:21.369063
> Verdict: FAIL
> Aider log present: True
> Aider result: FAILED
> Files modified by Aider: 0
> All syntax OK: False
> Aider reported FAILED
