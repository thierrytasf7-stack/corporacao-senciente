# [STORY-20260213000431-4] Implementar Rate Limiting nas API Routes
> **Status:** REVISADO
> **subStatus:** waiting_human_approval
> **Agente Sugerido:** @aider
> **Agente AIOS:** ðŸ’» @dev (Dex) - Full Stack Developer
> **Skill:** `/AIOS:agents:dev`
> **Tipo:** security
> **Dificuldade:** MEDIUM
> **Prioridade:** Alta
> **Criado em:** 2026-02-13 00:04:31

## Contexto
APIs sem rate limiting sao vulneraveis a DDoS e brute-force. Como o dashboard expoe dados dos agentes e do pipeline, proteger essas rotas e critico para a seguranca operacional do sistema Diana.

## Objetivo
As rotas de API do dashboard nao possuem rate limiting, ficando vulneraveis a abuso e ataques de forca bruta. Implementar rate limiter baseado em IP com limites configuraves por rota e resposta 429 padronizada.

## Responsavel
**ðŸ’» Dex** (Full Stack Developer) e o agente AIOS responsavel por esta task.
- **Foco:** Implementacao de codigo, debugging, testes unitarios e de integracao
- **Invocacao:** `/AIOS:agents:dev`
- **Executor runtime:** `@aider` (worker autonomo que processa a story)

## Arquivos Alvo
- `apps/dashboard/src/app/api/`
- `apps/dashboard/src/hooks/`
- `.aios-core/core/`

## Output Esperado
- Arquivo apps/dashboard/src/app/api/middleware/rate-limit.ts exportando funcao withRateLimit
- Headers X-RateLimit-Limit, X-RateLimit-Remaining e Retry-After presentes nas respostas
- Rotas publicas e de auth protegidas com limites configurados via env
- Testes em apps/dashboard/tests/middleware/rate-limit.test.ts cobrindo cenarios de bloqueio e reset

## Acceptance Criteria
- [x] Rate limiter implementado como middleware reutilizavel
- [?] Limites configuraveis por rota via variavel de ambiente
- [?] Resposta 429 com headers Retry-After corretos
- [?] Testes cobrindo cenarios de limite atingido e reset

## Constraints
- Usar Map nativo do JavaScript para armazenamento em memoria - sem Redis
- Limpar entradas expiradas do Map a cada 60 segundos para evitar memory leak
- Compativel com deploy em Vercel e execucao local com npm run dev
- NAO modificar arquivos fora do escopo listado em Arquivos Alvo
- NAO introduzir dependencias externas sem justificativa
- NAO quebrar funcionalidades existentes

## Instrucoes
1. Criar middleware de rate limiting em apps/dashboard/src/app/api/middleware/rate-limit.ts. 2. Usar Map em memoria com chave IP e contagem de requests por janela de tempo. 3. Aplicar o middleware nas rotas publicas e de autenticacao. 4. Configurar limites via env: RATE_LIMIT_WINDOW_MS e RATE_LIMIT_MAX_REQUESTS. 5. Escrever testes simulando multiplas requests do mesmo IP.

## Exemplo de Referencia
```
import { NextResponse } from 'next/server';

const rateLimitMap = new Map<string, { count: number; resetAt: number }>();

export function withRateLimit(handler: Function, maxRequests = 60, windowMs = 60000) {
  return async (request: Request) => {
    const ip = request.headers.get('x-forwarded-for') ?? 'unknown';
    const now = Date.now();
    const entry = rateLimitMap.get(ip);
    if (entry && now < entry.resetAt && entry.count >= maxRequests) {
      return NextResponse.json({ error: 'Too many requests' }, { status: 429 });
    }
    // ... update count and call handler
  };
}
```

## Aider Processing Log
- **Timestamp:** 2026-02-13 00:12:01
- **Duration:** 59.6s
- **Result:** SUCCESS
- **Files Modified:** apps/dashboard/src/app/api/route.ts, apps/dashboard/src/hooks/index.ts, apps/dashboard/src/hooks/use-agents.ts, apps/dashboard/src/hooks/use-aios-status.ts, apps/dashboard/src/hooks/use-monitor-events.ts, apps/dashboard/src/hooks/use-realtime-status.ts, .aios-core/core/branding.py, .aios-core/core/context_manager.py, .aios-core/core/fact_auditor.py, .aios-core/core/index (2).js, .aios-core/core/index.esm (2).js


## Review Results
> Reviewed at: 2026-02-13T00:12:10.399304
> Verdict: PASS
> Aider log present: True
> Aider result: SUCCESS
> Files modified by Aider: 11
> All syntax OK: True
> apps\dashboard\src\app\api\route.ts: PASS - JS/TS syntax OK
> apps\dashboard\src\hooks\index.ts: PASS - JS/TS syntax OK
> apps\dashboard\src\hooks\use-agents.ts: PASS - JS/TS syntax OK
> apps\dashboard\src\hooks\use-aios-status.ts: PASS - JS/TS syntax OK
> apps\dashboard\src\hooks\use-monitor-events.ts: PASS - JS/TS syntax OK
> apps\dashboard\src\hooks\use-realtime-status.ts: PASS - JS/TS syntax OK
> .aios-core\core\branding.py: PASS - Python syntax OK
> .aios-core\core\context_manager.py: PASS - Python syntax OK
> .aios-core\core\fact_auditor.py: PASS - Python syntax OK
> .aios-core\core\index (2).js: PASS - JS/TS syntax OK
> .aios-core\core\index.esm (2).js: PASS - JS/TS syntax OK
