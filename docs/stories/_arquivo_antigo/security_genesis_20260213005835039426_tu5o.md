# [STORY-20260213005835-4] Validacao de Schema para Stories Markdown
> **Status:** REVISADO
> **subStatus:** waiting_human_approval
> **Agente Sugerido:** @aider
> **Agente AIOS:** ✅ @qa (Quinn) - Test Architect & QA
> **Skill:** `/AIOS:agents:qa`
> **Tipo:** security
> **Dificuldade:** LOW
> **Prioridade:** Alta
> **Criado em:** 2026-02-13 00:58:35

## Contexto
Workers que processam stories malformadas podem falhar silenciosamente ou produzir resultados incorretos. Validacao na entrada do pipeline garante que apenas stories bem formadas sejam processadas, reduzindo falhas e retrabalho.

## Objetivo
Stories geradas pelo Genesis podem ter campos ausentes ou malformados. Implementar validador de schema que verifica estrutura obrigatoria antes dos workers processarem.

## Responsavel
**✅ Quinn** (Test Architect & QA) e o agente AIOS responsavel por esta task.
- **Foco:** Quality gates, test architecture, code review, validacao de criteria
- **Invocacao:** `/AIOS:agents:qa`
- **Executor runtime:** `@aider` (worker autonomo que processa a story)

## Arquivos Alvo
- `scripts/`

## Output Esperado
- Arquivo scripts/story_validator.py com funcao validate_story(filepath) retornando list[str]
- Schema validando: titulo (# [STORY-*]), Status, Agente Sugerido, Acceptance Criteria, Arquivos Alvo
- Mensagens de erro descritivas indicando campo e problema especifico
- Integracao no inicio de zero_worker_engine.py e aider_worker_engine.py como pre-check

## Acceptance Criteria
- [?] Validador de schema para stories implementado
- [?] Verifica campos obrigatorios: Status, Agente, Criteria, Arquivos Alvo
- [?] Stories invalidas rejeitadas com mensagem de erro clara
- [?] Integravel como pre-check nos workers

## Constraints
- Usar apenas stdlib Python (re, os) - sem jsonschema ou pydantic
- Funcao deve retornar lista de erros, nao lancar excecao
- Compativel com formato de stories gerado por worker_genesis_agent.py
- NAO modificar arquivos fora do escopo listado em Arquivos Alvo
- NAO introduzir dependencias externas sem justificativa
- NAO quebrar funcionalidades existentes

## Instrucoes
1. Criar scripts/story_validator.py com funcao validate_story(filepath). 2. Definir schema obrigatorio: titulo, status, agente, criteria, arquivos alvo. 3. Retornar lista de erros de validacao. 4. Integrar como check no inicio de zero_worker_engine.py e aider_worker_engine.py.

## Exemplo de Referencia
```
import re
from typing import List

REQUIRED_FIELDS = {
    'Status': r'\*\*Status:\*\*\s*(\S+)',
    'Agente Sugerido': r'\*\*Agente Sugerido:\*\*\s*(\S+)',
    'Tipo': r'\*\*Tipo:\*\*\s*(\S+)',
}

def validate_story(filepath: str) -> List[str]:
    errors: List[str] = []
    with open(filepath, 'r', encoding='utf-8') as f:
        content = f.read()
    if not re.search(r'^# \[STORY-', content, re.MULTILINE):
        errors.append('Missing story title with [STORY-*] format')
    for field, pattern in REQUIRED_FIELDS.items():
        if not re.search(pattern, content):
            errors.append(f'Missing required field: {field}')
    return errors
```


## Review Results
> Reviewed at: 2026-02-13T01:05:26.661784
> Verdict: FAIL
> Aider log present: False
> Aider result: None
> Files modified by Aider: 0
> All syntax OK: True
> scripts\aider_with_fallback.py: PASS - Python syntax OK
> scripts\aider_worker_engine.py: PASS - Python syntax OK
> scripts\audit-dependencies.py: PASS - Python syntax OK
> scripts\check-diana-status.py: PASS - Python syntax OK
> scripts\gen-audit.py: PASS - Python syntax OK
> scripts\list-diana-procs.py: PASS - Python syntax OK
> scripts\pipeline-validate.py: PASS - Python syntax OK
> scripts\pm2-wrapper.js: PASS - JS/TS syntax OK
> scripts\pm2-wrapper.py: PASS - Python syntax OK
> scripts\qa-explore-routes.js: PASS - JS/TS syntax OK
> scripts\sentinela_escrivao_aider.py: PASS - Python syntax OK
> scripts\sentinela_genesis_saude.py: PASS - Python syntax OK
> scripts\sentinela_revisor_agentezero.py: PASS - Python syntax OK
> scripts\stress-test-20-stories.py: PASS - Python syntax OK
> scripts\stress-test-live.py: PASS - Python syntax OK
> scripts\stress-test-mini.py: PASS - Python syntax OK
> scripts\stress-test-quick.py: PASS - Python syntax OK
> scripts\verificar_sistema.py: PASS - Python syntax OK
> scripts\worker_genesis_agent.py: PASS - Python syntax OK
> scripts\write-audit.js: PASS - JS/TS syntax OK
> scripts\zero_worker_engine.py: PASS - Python syntax OK
> scripts\migration\MigrationState-README.md: PASS - Markdown OK (11783 bytes, has headings)
> scripts\migration\README.md: PASS - Markdown OK (12058 bytes, has headings)
> scripts\migration\TASK-2.1-COMPLETION.md: PASS - Markdown OK (8345 bytes, has headings)
> scripts\migration\TASK-2.2-COMPLETION.md: PASS - Markdown OK (10856 bytes, has headings)
> scripts\migration\docker-cleanup-report.json: PASS - File exists (7785 bytes, no syntax check for .json)
> scripts\migration\inventory.json: PASS - File exists (82490 bytes, no syntax check for .json)
> scripts\migration\sample-inventory-output.json: PASS - File exists (3861 bytes, no syntax check for .json)
> scripts\migration\test-output\container-termination-report.json: PASS - File exists (2357 bytes, no syntax check for .json)
> scripts\migration\test-output\mock-inventory.json: PASS - File exists (417 bytes, no syntax check for .json)
> scripts\migration\test-output\test-inventory.json: PASS - File exists (149 bytes, no syntax check for .json)
> scripts\migration\test-output\test-migration-state.json: PASS - File exists (820 bytes, no syntax check for .json)
> scripts\senciencia\daemon_auto_continue.js: PASS - JS/TS syntax OK

## Aider Processing Log
- **Timestamp:** 2026-02-13 01:06:57
- **Duration:** 120.6s
- **Result:** FAILED
- **Error:** Exit code 1


## Review Results
> Reviewed at: 2026-02-13T01:06:59.474235
> Verdict: FAIL
> Aider log present: True
> Aider result: FAILED
> Files modified by Aider: 0
> All syntax OK: False
> Aider reported FAILED
