# [STORY-20260213012907-2] Sanitizar Inputs nos Scripts de Worker
> **Status:** REVISADO
> **subStatus:** waiting_human_approval
> **Agente Sugerido:** @agente-zero
> **Agente AIOS:** ✅ @qa (Quinn) - Test Architect & QA
> **Skill:** `/AIOS:agents:qa`
> **Tipo:** security
> **Dificuldade:** MEDIUM
> **Prioridade:** Alta
> **Criado em:** 2026-02-13 01:29:07

## Contexto
Stories sao geradas por agentes autonomos e podem conter conteudo inesperado. Se um path extraido de uma story for passado diretamente a subprocess, um atacante poderia injetar comandos via stories maliciosas, comprometendo o sistema host.

## Objetivo
Os workers Python leem conteudo de stories markdown e usam em subprocessos sem sanitizacao. Implementar validacao de inputs para prevenir injecao de comandos via conteudo malicioso em stories.

## Responsavel
**✅ Quinn** (Test Architect & QA) e o agente AIOS responsavel por esta task.
- **Foco:** Quality gates, test architecture, code review, validacao de criteria
- **Invocacao:** `/AIOS:agents:qa`
- **Executor runtime:** `@agente-zero` (worker autonomo que processa a story)

## Arquivos Alvo
- `scripts/`

## Output Esperado
- Funcao sanitize_path(path) em scripts/worker_utils.py validando contra directory traversal
- Zero ocorrencias de shell=True nos subprocess.run dos workers
- Whitelist de caracteres permitidos em paths aplicada antes de qualquer subprocess
- Testes em scripts/tests/test_sanitize.py com payloads como '../../../etc/passwd' e '; rm -rf /'

## Acceptance Criteria
- [?] Inputs de stories sanitizados antes de uso em subprocess
- [?] Paths validados contra directory traversal
- [?] Nenhum shell=True desnecessario nos subprocess.run
- [?] Testes com payloads maliciosos confirmando protecao

## Constraints
- Paths devem ser resolvidos com os.path.realpath e validados contra BASE_DIR
- Nao usar shlex.quote como unica protecao - validar antes
- Manter compatibilidade com paths Windows (backslash e forward slash)
- NAO modificar arquivos fora do escopo listado em Arquivos Alvo
- NAO introduzir dependencias externas sem justificativa
- NAO quebrar funcionalidades existentes

## Instrucoes
1. Auditar todos os subprocess.run nos workers Python. 2. Remover shell=True onde nao for necessario. 3. Validar e sanitizar file paths extraidos das stories. 4. Adicionar whitelist de caracteres permitidos em paths.

## Exemplo de Referencia
```
import os
import re

BASE_DIR = 'C:/Users/User/Desktop/Diana-Corporacao-Senciente'
ALLOWED_PATH_CHARS = re.compile(r'^[a-zA-Z0-9_\-./\\]+$')

def sanitize_path(raw_path: str) -> str | None:
    if not ALLOWED_PATH_CHARS.match(raw_path):
        return None
    resolved = os.path.realpath(os.path.join(BASE_DIR, raw_path))
    if not resolved.startswith(os.path.realpath(BASE_DIR)):
        return None  # directory traversal attempt
    return resolved
```


## Execution Log
> Executed at: 2026-02-13T01:30:15.832520
> Total targets: 1
> Files checked: 33
> Overall: ALL PASS
> scripts\aider_with_fallback.py: PASS - Python syntax OK
> scripts\aider_worker_engine.py: PASS - Python syntax OK
> scripts\audit-dependencies.py: PASS - Python syntax OK
> scripts\check-diana-status.py: PASS - Python syntax OK
> scripts\gen-audit.py: PASS - Python syntax OK
> scripts\list-diana-procs.py: PASS - Python syntax OK
> scripts\pipeline-validate.py: PASS - Python syntax OK
> scripts\pm2-wrapper.js: PASS - JS/TS syntax OK
> scripts\pm2-wrapper.py: PASS - Python syntax OK
> scripts\qa-explore-routes.js: PASS - JS/TS syntax OK
> scripts\sentinela_escrivao_aider.py: PASS - Python syntax OK
> scripts\sentinela_genesis_saude.py: PASS - Python syntax OK
> scripts\sentinela_revisor_agentezero.py: PASS - Python syntax OK
> scripts\stress-test-20-stories.py: PASS - Python syntax OK
> scripts\stress-test-live.py: PASS - Python syntax OK
> scripts\stress-test-mini.py: PASS - Python syntax OK
> scripts\stress-test-quick.py: PASS - Python syntax OK
> scripts\verificar_sistema.py: PASS - Python syntax OK
> scripts\worker_genesis_agent.py: PASS - Python syntax OK
> scripts\write-audit.js: PASS - JS/TS syntax OK
> scripts\zero_worker_engine.py: PASS - Python syntax OK
> scripts\migration\MigrationState-README.md: PASS - Markdown OK (11783 bytes, has headings)
> scripts\migration\README.md: PASS - Markdown OK (12058 bytes, has headings)
> scripts\migration\TASK-2.1-COMPLETION.md: PASS - Markdown OK (8345 bytes, has headings)
> scripts\migration\TASK-2.2-COMPLETION.md: PASS - Markdown OK (10856 bytes, has headings)
> scripts\migration\docker-cleanup-report.json: PASS - File exists (7785 bytes, no syntax check for .json)
> scripts\migration\inventory.json: PASS - File exists (82490 bytes, no syntax check for .json)
> scripts\migration\sample-inventory-output.json: PASS - File exists (3861 bytes, no syntax check for .json)
> scripts\migration\test-output\container-termination-report.json: PASS - File exists (2357 bytes, no syntax check for .json)
> scripts\migration\test-output\mock-inventory.json: PASS - File exists (417 bytes, no syntax check for .json)
> scripts\migration\test-output\test-inventory.json: PASS - File exists (149 bytes, no syntax check for .json)
> scripts\migration\test-output\test-migration-state.json: PASS - File exists (820 bytes, no syntax check for .json)
> scripts\senciencia\daemon_auto_continue.js: PASS - JS/TS syntax OK
