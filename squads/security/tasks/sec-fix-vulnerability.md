---
task: Fix Vulnerability
responsavel: "@security-engineer"
responsavel_type: agent
atomic_layer: task
trigger: "*fix"
Entrada: |
  - vulnerability: Descricao da vulnerabilidade ou CVE
  - location: Arquivo:linha (se conhecido)
  - severity: critical | high | medium | low
Saida: |
  - fix_applied: Descricao do fix aplicado
  - files_changed: Arquivos modificados
  - verification: Como verificar que o fix funciona
Checklist:
  - "[ ] Entender a vulnerabilidade (root cause)"
  - "[ ] Identificar todos os locais afetados"
  - "[ ] Propor fix (com justificativa)"
  - "[ ] Aplicar fix (ou delegar para @dev se complexo)"
  - "[ ] Verificar que fix nao quebra funcionalidade"
  - "[ ] Verificar que fix nao introduz nova vulnerabilidade"
  - "[ ] Documentar fix para referencia futura"
---

# *fix - Fix Vulnerability

Corrigir vulnerabilidade identificada com guidance e verificacao.

## Flow

```
1. Analyze vulnerability
   ├── Understand root cause (WHY it's vulnerable)
   ├── Determine attack vector (HOW it can be exploited)
   ├── Assess blast radius (WHAT is affected)
   └── Check if CVE exists (reference number)

2. Find all affected locations
   ├── Search for same pattern across codebase
   ├── Don't fix just one instance - fix ALL
   └── Check if pattern exists in tests too

3. Design fix
   ├── Use SAFE alternatives from patterns database
   ├── Leverage existing security-utils.js functions
   ├── Prefer defense-in-depth (multiple layers)
   └── Minimize code change surface

4. Apply fix
   ├── If simple (pattern replacement) → apply directly
   ├── If complex (architectural change) → delegate to @dev
   ├── If dependency update → npm audit fix or manual upgrade
   └── If secret exposed → rotate credentials FIRST, then fix code

5. Verify fix
   ├── Re-run relevant security scan
   ├── Verify original vulnerability no longer detected
   ├── Verify no new vulnerabilities introduced
   ├── Verify existing tests still pass
   └── Add security test for this specific case

6. Document
   ├── What was vulnerable
   ├── How it was fixed
   ├── How to prevent recurrence
   └── Add to security regression checks
```

## Fix Priority Matrix

| Severity | Action | Who | Timeline |
|----------|--------|-----|----------|
| Critical | Fix NOW, block all deploys | Sentinel + @dev | Immediate |
| High | Fix ASAP, block release | Sentinel + @dev | Same day |
| Medium | Fix in sprint | @dev with guidance | Sprint |
| Low | Track and fix | @dev when available | Backlog |

## Common Fixes

| Vulnerability | Quick Fix |
|---------------|-----------|
| SQL injection | Replace concat with parameterized query |
| XSS | Replace innerHTML with textContent |
| Command injection | Replace exec() with execFile() |
| Path traversal | Add safePath() from security-utils |
| Hardcoded secret | Move to .env, add to .gitignore |
| Weak crypto | Replace MD5/SHA1 with SHA-256/bcrypt |
| Missing auth | Add authentication middleware |
| Missing rate limit | Add RateLimiter from security-utils |
