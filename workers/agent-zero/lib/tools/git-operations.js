/**
 * Tool: git_operations
 * Git completo: add, commit, push, PR, release
 * v4.0 UNLEASHED - Acesso total
 */

const { exec } = require('child_process');
const { promisify } = require('util');
const execAsync = promisify(exec);

class GitOperationsTool {
  constructor(config, projectRoot) {
    this.config = config;
    this.projectRoot = projectRoot;
  }

  definition() {
    return {
      name: 'git_operations',
      description: 'Execute git operations: add, commit, push, pull, branch, status, log, diff, PR, release. Full git access.',
      parameters: {
        type: 'object',
        properties: {
          operation: {
            type: 'string',
            enum: ['add', 'commit', 'push', 'pull', 'branch', 'status', 'log', 'diff', 'pr', 'release'],
            description: 'Git operation to perform'
          },
          args: {
            type: 'object',
            description: 'Operation-specific arguments',
            properties: {
              files: { type: 'string', description: 'For add: files to add (default ".")' },
              message: { type: 'string', description: 'For commit: commit message' },
              branch: { type: 'string', description: 'Branch name' },
              force: { type: 'boolean', description: 'For push: force push' },
              create: { type: 'boolean', description: 'For branch: create new branch' },
              delete: { type: 'boolean', description: 'For branch: delete branch' },
              name: { type: 'string', description: 'For branch: branch name' },
              title: { type: 'string', description: 'For PR: PR title' },
              body: { type: 'string', description: 'For PR: PR body' },
              version: { type: 'string', description: 'For release: version tag' },
              limit: { type: 'number', description: 'For log: number of commits' },
              target: { type: 'string', description: 'For diff: target to diff against' }
            }
          }
        },
        required: ['operation']
      }
    };
  }

  async execute({ operation, args = {} }) {
    try {
      let command;

      switch (operation) {
        case 'add':
          command = `git add ${args.files || '.'}`;
          break;

        case 'commit':
          const message = args.message || 'Agent Zero auto-commit';
          command = `git commit -m "${message}"`;
          break;

        case 'push':
          const branch = args.branch || 'main';
          const force = args.force ? '--force' : '';
          command = `git push ${force} origin ${branch}`;
          break;

        case 'pull':
          command = `git pull origin ${args.branch || 'main'}`;
          break;

        case 'branch':
          if (args.create) {
            command = `git checkout -b ${args.name}`;
          } else if (args.delete) {
            command = `git branch -D ${args.name}`;
          } else {
            command = `git branch`;
          }
          break;

        case 'status':
          command = `git status`;
          break;

        case 'log':
          command = `git log --oneline -${args.limit || 10}`;
          break;

        case 'diff':
          command = `git diff ${args.target || ''}`;
          break;

        case 'pr':
          const title = args.title || 'Agent Zero PR';
          const body = args.body || 'Auto-generated by Agent Zero v4';
          command = `gh pr create --title "${title}" --body "${body}"`;
          break;

        case 'release':
          const version = args.version || 'auto';
          command = `gh release create ${version} --generate-notes`;
          break;

        default:
          return {
            success: false,
            error: `Unknown git operation: ${operation}`
          };
      }

      console.log(`[GIT-OPS] Executing: ${command}`);

      const { stdout, stderr } = await execAsync(command, {
        cwd: this.projectRoot,
        timeout: 30000
      });

      return {
        success: true,
        tool: 'git_operations',
        operation: operation,
        command: command,
        output: stdout,
        stderr: stderr || null
      };

    } catch (error) {
      return {
        success: false,
        tool: 'git_operations',
        operation: operation,
        error: error.message,
        stderr: error.stderr || null
      };
    }
  }
}

module.exports = GitOperationsTool;
