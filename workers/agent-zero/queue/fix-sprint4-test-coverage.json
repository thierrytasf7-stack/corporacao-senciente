{
  "id": "fix-sprint4-test-coverage",
  "agent": "qa",
  "task_type": "test-implementation",
  "model": "arcee-ai/trinity-large-preview:free",
  "aios_guide_path": ".aios-core/development/agents/qa.md",
  "context_files": [
    "src/az_os/core/react_loop.py",
    "src/az_os/core/model_router.py",
    "tests/test_core.py",
    "tests/conftest.py"
  ],
  "tools_required": ["file_read", "file_write"],
  "prompt": "FIX: Missing comprehensive test coverage for Sprint 4 autonomy features\n\n**Issue:** HIGH priority - Critical for production reliability\n**Files:** src/az_os/core/react_loop.py, src/az_os/core/model_router.py\n**Current Coverage:** 45% (target: 80%+)\n\n**Required Tests:**\n\n### ReActLoop Tests (tests/test_react_loop.py - NEW FILE):\n1. **Success Scenario:**\n   - Test complete Reason → Act → Observe cycle\n   - Verify task completion after 3 turns\n   - Check reasoning traces captured\n\n2. **Failure Scenario:**\n   - Test tool execution failure handling\n   - Verify graceful degradation\n   - Check error messages user-friendly\n\n3. **Max Iterations:**\n   - Test loop terminates at max_turns\n   - Verify no infinite loops\n   - Check final state correct\n\n4. **Integration:**\n   - Test with real ExecutionEngine (mocked subprocess)\n   - Test with real ModelRouter\n   - Verify tool execution integration\n\n### ModelRouter Tests (tests/test_model_router.py - NEW FILE):\n1. **Selection Logic:**\n   - Test SIMPLE task → fast model (Haiku)\n   - Test COMPLEX task → powerful model (Opus)\n   - Test MEDIUM task → balanced model (Sonnet)\n\n2. **Fallback Behavior:**\n   - Test when preferred model unavailable\n   - Test cost-based fallback\n   - Test quality threshold enforcement\n\n3. **Learning Mechanism:**\n   - Test model performance tracking\n   - Test selection improvement over time\n   - Test learning state persistence\n\n**Test Template:**\n```python\nimport pytest\nfrom unittest.mock import AsyncMock, patch\nfrom az_os.core.react_loop import ReActLoop\nfrom az_os.core.model_router import ModelRouter\n\nclass TestReActLoop:\n    @pytest.mark.asyncio\n    async def test_success_scenario(self):\n        loop = ReActLoop(max_turns=5)\n        with patch('az_os.core.execution_engine.ExecutionEngine') as mock_engine:\n            mock_engine.execute_python.return_value = {\"success\": True}\n            result = await loop.run(task=\"Test task\")\n            assert result.success is True\n            assert len(result.history) == 3  # Reason + Act + Observe\n\nclass TestModelRouter:\n    def test_simple_task_selection(self):\n        router = ModelRouter()\n        model = router.select_model(complexity=\"SIMPLE\")\n        assert model.name == \"claude-haiku-4-5\"\n```\n\n**Success Criteria:**\n- [ ] ReActLoop test coverage ≥ 80%\n- [ ] ModelRouter test coverage ≥ 80%\n- [ ] All acceptance criteria from Sprint 4 verified\n- [ ] Integration tests passing\n- [ ] No regressions in existing tests",
  "acceptance_criteria": [
    "ReActLoop test file created with 80%+ coverage",
    "ModelRouter test file created with 80%+ coverage",
    "All success/failure/max-iterations scenarios tested",
    "Integration tests with ExecutionEngine working",
    "Selection logic tests for SIMPLE/MEDIUM/COMPLEX",
    "Fallback behavior tests passing",
    "Overall Sprint 4 coverage ≥ 80%"
  ],
  "max_tool_iterations": 15,
  "self_review": true,
  "quality_threshold": 9
}
